<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  	<style>
    	h2 {
      	text-align: center;
    	}

    	h3 {
     	text-align: center;
      	font-size: 80%;
      	font-weight: lighter;
    	}

    	html,
    	body,
    	svg {
    		height: auto;
    		width: 100%;
    		overflow: visible;
    	}

    	.map {
    		outline-style: solid;
    		height: auto;
    		width: 100%;
    	}

    	circle {
    		fill: orange;
    		stroke: black;
    		stroke-width: 0.7;
    		opacity: 0.7;
    	}

  	</style>
  	<script type="text/javascript">
  		function draw(geo_data) {
  			d3.select("body")
  				.append("h2")
  				.text("Total Employment by Occupation per Year");

  			d3.select("body")
  				.append("h3")
  				.text("2010-2016");

  			var svg = d3.select("body")
  				.append("svg")
  				.append('g')
  				.attr('class', 'map');

  			var projection = d3.geo.mercator()
  				.scale(600)
  				.translate([1600,650]);

  			var path = d3.geo.path().projection(projection);

  			var map = svg.selectAll('path')
  				.data(geo_data.features)
  				.enter()
  				.append('path')
  				.attr('d', path)
  				.style('fill', 'rgb(9,157,217)')
  				.style('stroke', 'black')
  				.style('stroke-width', 0.5);

  			function plot_points(data) {

  				function agg(leaves) {
  					
  					var state_data = d3.set();

  					leaves.forEach(function(d) {
  						state_data.add(d['tot_emp']),
  						state_data.add(+d['latitude']),
  						state_data.add(+d['longitude']);
  					});

  					var coords = leaves.map(function(d) { 
  						return projection([+d['longitude'], +d['latitude']]); 
  					});

  					var employment = state_data.values()[0];

  					return {
  						'tot_emp' : employment,
  						'center_x': coords[0][0],
  						'center_y': coords[0][1]
  					};
  				}

  				// draw circles logic
  				var nested = d3.nest()
  					.key(function(d) {
  						return d['year'].getUTCFullYear();
  					}) //to be able to filter by year, this key must be first
  					.key(function(d) {
  						return d['state'];
  					})
  					.rollup(agg)
  					.entries(data);
  				console.log(nested);
  				//get the range of employment numbers across entire dataset	
  				var employment_max = d3.max(data, function(d) {
  					return d['tot_emp'];
  				});

  				var radius = d3.scale.sqrt()
  					.domain([0, employment_max])
  					.range([0,12]);

  				function key_func(d) {
  					return d['key'];
  				}

  				

  				function update(year) {
                	var filtered = nested.filter(function(d){
                		return new Date(d['key']).getUTCFullYear() === year;
                	}); 

                	//flatten the nested array so that there is an object for each state
                	var filtered2 = filtered[0].values;

                	d3.select("h3")
                		.text(year);

                	//add a circle for every data element possible
  					svg.append('g')
  						.attr("class", "bubble")
  						.selectAll("circle")
  						.data(filtered2)
  						.enter()
  						.append("circle")
                  		.attr('cx', function(d){
                  			return d.values['center_x']
                  		})
                  		.attr('cy', function(d){
                  			return d.values['center_y']
                  		})
                  		.attr('r', function(d){
                  			return radius(d.values['tot_emp'])
                  		});

               		var circles = svg.selectAll('circle')
                               .data(filtered2);

             		 circles.exit().remove();

				}

				var years = [2012, 2013, 2014, 2015, 2016];

				var year_idx = 0;

				var year_interval = setInterval(function() {
					update(years[year_idx]);

					year_idx++;

					if(year_idx >= years.length) {
						clearInterval(year_interval);
					}
				}, 1000);

			}

  			var format = d3.time.format("%Y");


   			d3.csv("./State_OES.csv", function(d) {
    		// transform data
    			d['year'] = format.parse(d['year']);
    			d['tot_emp'] = +d['tot_emp'];
    			return d;
    		}, plot_points);
   		};
  		</script>
	</head>
<body>
  	<script type="text/javascript">
  		d3.json("./map.json", draw);
  	</script>
</body>
</html>
