<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  	<style>
    	h2 {
      	text-align: center;
    	}

    	h3 {
     	text-align: center;
      	font-size: 80%;
      	font-weight: lighter;
    	}

    	div.year_buttons {
    		position: fixed;
    		top: 5px;
    		left: 50px;
    	}

    	div.year_buttons div {
       		background-color: rgb(251, 201, 127);
        	padding: 3px;
        	margin: 7px;
      	}

    	html,
    	body,
    	svg {
    		height: auto;
    		width: 100%;
    		overflow: visible;
    	}

    	.map {
    		outline-style: solid;
    		height: auto;
    		width: 100%;
    	}

    	circle {
    		stroke: black;
    		stroke-width: 0.7;
    		opacity: 0.7;
    	}

    	.select {
    		position: fixed;
    		top: 100px;
    		left: 500px;
    	}

  	</style>
  	<script type="text/javascript">
  		function draw(geo_data) {
  			d3.select("body")
  				.append("h2")
  				.text("Highest Average Salary per Year");

  			d3.select("body")
  				.append("h3")
  				.text("2010-2016");

  			var svg = d3.select("body")
  				.append("svg")
  				.append('g')
  				.attr('class', 'map');

  			var projection = d3.geo.mercator()
  				.center([20,0])
  				.scale(500)
  				.translate([1700,650]);

  			var path = d3.geo.path().projection(projection);

  			var map = svg.selectAll('path')
  				.data(geo_data.features)
  				.enter()
  				.append('path')
  				.attr('d', path)
  				.style('fill', 'lightBlue')
  				.style('stroke', 'black')
  				.style('stroke-width', 0.5);


  			function plot_points(data) {
  				//add all possible invisible circles
				var industries = ["Select an Industry: ", 
					"Legal Occupations", 
					"Management Occupations",
					"Healthcare Practitioners and Technical Occupations", 
					"Architecture and Engineering Occupations", 
					"Business and Financial Operations Occupations", 
					"Computer and Mathematical Occupations",
					"Life, Physical, and Social Science Occupations", 
					"Arts, Design, Entertainment, Sports, and Media Occupations", 
					"Education, Training, and Library Occupations",
					"Protective Service Occupations",
					"Construction and Extraction Occupations",
					"Sales and Related Occupations",
					"Community and Social Service Occupations",
					"Production Occupations",
					"Installation, Maintenance, and Repair Occupations",
					"Transportation and Material Moving Occupations",
					"Farming, Fishing, and Forestry Occupations",
					"Office and Administrative Support Occupations",
					"Healthcare Support Occupations",		
					"Personal Care and Service Occupations",
					"Building and Grounds Cleaning and Maintenance Occupations",
					"Food Preparation and Serving Related Occupations"];

				var select = d3.select('body')
					.append('select')
					.attr('class', 'select')
					.on('change', onchange);

				var options = select.selectAll('option')
					.data(industries).enter()
					.append('option')
					.text(function(d){
						return d;
					});

  				var nested = d3.nest()
  					.key(function(d) {
  						return d['year'].getUTCFullYear();
  					})
  					.key(function(d) {
 						return d['occ_title'];
 					})
  					.rollup(function(leaves){
  						var max_hourly_salary = d3.max(leaves, function(d){
  							return d['h_mean'];
  						});

  						var max_employment = d3.max(leaves, function(d){
  							return d['tot_emp']
  						});

  						for (var i = 0; i<leaves.length; i++){
  							if(leaves[i]['h_mean'] === max_hourly_salary){
  								var wage_state = leaves[i]['state'];
  								var coords = projection([+leaves[i]['longitude'], +leaves[i]['latitude']]);
  								var center_x = coords[0];
  								var center_y = coords[1];
  							} else {
  								continue;
  							}
  						}

  						for (var i = 0; i<leaves.length; i++){
  							if (leaves[i]['tot_emp'] === max_employment){
  								var emp_state = leaves[i]['state'];
  							} else{
  								continue;
  							}
  						}

  						return {
  							'state' : wage_state,
  							'max_hourly_salary' : +max_hourly_salary,
  							'center_x' : center_x,
  							'center_y' : center_y,
  							'emp_state': emp_state
  						};
  					})
  					.entries(data);
  				console.log(nested);

  				//get the range of hourly mean values across entire dataset
  				var hourly_salary_extent = d3.extent(data, function(d) {
  					return +d['h_mean'];
  				});

  				var radius = d3.scale.sqrt()
  					.domain(hourly_salary_extent)
  					.range([5,15]);

  				function key_func(d) {
  					return d['key'];
  				}

  				select.on("change", function(d) {

  					//select which industry to look at from the dropdown menu
  					var selectValue = d3.select('select').property('value')

					svg.append('g')
		  				.attr("class", "bubble")
		  				.selectAll("circle")
		  				.data(nested, key_func)
		  				.enter()
		  				.append("circle")
		  				.attr('cx', function(d) { 
		  					for (var idx = 0; idx < d.values.length; idx++){
			  					if (d.values[idx]['key'] === selectValue){
			  						var center_x = d.values[idx].values['center_x'];
			  					}
			  				}
			  				return center_x;
			  			})
			  			.attr('cy', function(d) { 
		  					for (var idx = 0; idx < d.values.length; idx++){
			  					if (d.values[idx]['key'] === selectValue){
			  						var center_y = d.values[idx].values['center_y'];
			  					}
			  				}
			  				return center_y;
			  			})
			  			.attr('r', 0)
			  			
			  			

	                

	  				function update(year) {
	                	var filtered = nested.filter(function(d){
	                		return new Date(d['key']).getUTCFullYear() === year;
	                	});

	                	d3.select("h3")
	                		.text(year);


		             	var circles = svg.selectAll('circle')
		                               .data(filtered, key_func);

		                circles.exit().remove();

			             circles.enter()
			             	.append("circle")
			             	.transition()
			             	.duration(500)
			  				.attr('cx', function(d) { 
		  						for (var idx = 0; idx < d.values.length; idx++){
			  						if (d.values[idx]['key'] === selectValue){
			  							var center_x = d.values[idx].values['center_x'];
			  						}
			  					}
			  					return center_x;
			  				})
			  				.attr('cy', function(d) { 
		  					for (var idx = 0; idx < d.values.length; idx++){
			  					if (d.values[idx]['key'] === selectValue){
			  						var center_y = d.values[idx].values['center_y'];
			  						}
			  					}
			  					return center_y;
			  				})
			  				.attr('r', function(d) { 
		  					for (var idx = 0; idx < d.values.length; idx++){
			  					if (d.values[idx]['key'] === selectValue){
			  						var r = radius(d.values[idx].values['max_hourly_salary']);
			  						}
			  					}
			  					return r;
			  				})
			  				.attr("fill", "#d95f02");

			  				function color_high_emp_state(d){
			  					var selected_data = filtered[0].values;

			  					for(var idx = 0; idx< selected_data.length; idx++){

			  						if (selected_data[idx]['key']===selectValue){
			  							var emp_state = selected_data[idx].values['emp_state'];
			  							if(d.properties.NAME === emp_state){
			  								return "darkBlue";
			  							}else{
			  								return "lightBlue";
			  							}
			  						}
			  					}
			  				}
			  				
			  				svg.selectAll('path')
			  					.transition()
			  					.duration(500)
			  					.style('fill', color_high_emp_state)
			  					.style('stroke', "black")
			  				

			  			}
						

					var years = [2010, 2011, 2012, 2013, 2014, 2015, 2016];

					var year_idx = 0;

					var year_interval = setInterval(function() {
						update(years[year_idx]);

						year_idx++;

						if(year_idx >= years.length) {
							clearInterval(year_interval);

							var year_buttons = d3.select("body")
								.append("div")
								.attr("class", "year_buttons")
								.selectAll("div")
								.data(years)
								.enter()
								.append("div")
								.text(function(d) {
									return d;
								})
							year_buttons.on("click", function(d) {
								d3.select(".year_buttons")
									.selectAll("div")
									.transition()
									.duration(500)
									.style("color", "black")
									.style("background", "rgb(251, 201, 127)");
								d3.select(this)
									.transition()
									.duration(500)
									.style("background", "lightBlue")
									.style("color", "white");
								update(d);
							});
						}
					}, 1000);
				})
			}

  			var format = d3.time.format("%Y");


   			d3.csv("./State_OES.csv", function(d) {
    		// transform data
    			d['year'] = format.parse(d['year']);
    			d['tot_emp'] = +d['tot_emp'];
    			d['h_mean'] = +d['h_mean'];
    			
    			return d;
    		}, plot_points);
   		};
  		</script>
	</head>
<body>
  	<script type="text/javascript">
  		d3.json("./map.json", draw);
  	</script>
</body>
</html>
