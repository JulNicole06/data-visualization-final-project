<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  	<style>
  		* {
		    -webkit-box-sizing: border-box;
		    -moz-box-sizing: border-box;
		    -ms-box-sizing: border-box;
		    box-sizing: border-box;
		}
  		h1 {
      		text-align: center;
      		font-size:  100%;
      		order: 1;
    	}

    	h2 {
    		font-size: 90%;
    		text-align: center;
    		order: 2;
    	}

    	div.year_buttons {
    		display: -webkit-flex;
  			display: flex;
  			flex-wrap: wrap;
  			width: 50%;
  			order: 4;
  			justify-content: space-between;
  			margin: 2%;
    	}

    	div.year_buttons div {
        	display: -webkit-flex;
  			display: flex;
  			outline: black solid;
  			outline-width: thin;
      	}

    	html, body, svg{
    		display: -webkit-flex;
  			display: flex;
  			justify-content: center;
  			align-items: center;
    	}

    	body {
    		flex-direction: column;
    	}

    	svg{
    		order: 5;
    	}

    	.select {
    		display: -webkit-flex;
  			display: flex;
    		margin: auto;
    		order: 3;
    	}

    	.legend-title {
   			font-weight: bold;
   			font-size: 80%;

		}

		.legend-box {
    		fill: none;
    		stroke: #888;
    		font-size: 10px;
		}

		.legend-items{
			font-size: 60%;
		}



  	</style>
  	<script type="text/javascript">
  		function draw(geo_data) {

  			d3.select("body")
  				.append("h1")
  				.text("Average Hourly Wages from 2010-2016");


  			d3.select("body")
  				.append("h2")
  				.text("Select an industry to see how the average salary changes year to year in each state");

  			var width = 960,
  				height = 500;

  			var svg = d3.select("body")
  				.append("svg")
  				.attr("width", width)
  				.attr("height", height)
  				.append('g')
  				.attr('class', 'map');

  			var projection = d3.geo.albersUsa()
  				.scale(1070)
  				.translate([width/2, height/2])

  			var path = d3.geo.path().projection(projection);

  			var map = svg.selectAll('path')
  				.data(geo_data.features)
  				.enter()
  				.append('path')
  				.attr('d', path)
  				.style('fill', '#fcfbfd')
  				.style('stroke', 'black')
  				.style('stroke-width', 0.5);


  			var paths = svg.selectAll('path')
		  		.attr("id", function(d){
		  			statesRemoved = ["American Samoa", "Guam", "Commonwealth of the Northern Mariana Islands", "United States Virgin Islands", "Puerto Rico"]
		  			for (var i = 0; i<statesRemoved.length; i++){
		  				if (d.properties.NAME === statesRemoved[i]){
		  					return "remove";
		  				} 
		  			}
		  		})

		  	svg.selectAll('path#remove').remove();
		  	

  			function plot_points(data) {
  				//add all possible invisible circles
				var industries = ["Select an Industry: ", 
					"Legal Occupations", 
					"Management Occupations",
					"Healthcare Practitioners and Technical Occupations", 
					"Architecture and Engineering Occupations", 
					"Business and Financial Operations Occupations", 
					"Computer and Mathematical Occupations",
					"Life, Physical, and Social Science Occupations", 
					"Arts, Design, Entertainment, Sports, and Media Occupations", 
					"Education, Training, and Library Occupations",
					"Protective Service Occupations",
					"Construction and Extraction Occupations",
					"Sales and Related Occupations",
					"Community and Social Service Occupations",
					"Production Occupations",
					"Installation, Maintenance, and Repair Occupations",
					"Transportation and Material Moving Occupations",
					"Farming, Fishing, and Forestry Occupations",
					"Office and Administrative Support Occupations",
					"Healthcare Support Occupations",		
					"Personal Care and Service Occupations",
					"Building and Grounds Cleaning and Maintenance Occupations",
					"Food Preparation and Serving Related Occupations"];

				var select = d3.select('body')
					.append('select')
					.attr('class', 'select')
					.on('change', onchange);

				var options = select.selectAll('option')
					.data(industries).enter()
					.append('option')
					.text(function(d){
						return d;
					});

  				var nested = d3.nest()
  					.key(function(d) {
  						return d['year'].getUTCFullYear();
  					})
  					.key(function(d) {
 						return d['occ_title'];
 					})
  					.rollup(function(leaves){
  						//get list of all states and corresponding avg hourly wages
  						wage_array = []
  						for (var i = 0; i<leaves.length; i++){
  							wage_array.push([(leaves[i]['state']), (leaves[i]['h_mean'])])
  						}

  						//get range across all years for scaling choropleth
  						var minWage = d3.min(leaves, function(d){
  							return +d['h_mean'];
  						});

  						var maxWage = d3.max(leaves, function(d){
  							return +d['h_mean'];
  						});


  						return {
  							'wages': wage_array,
  							'minWage' : minWage,
  							'maxWage': maxWage
  						};
  					})
  					.entries(data);

  				function key_func(d) {
  					return d['key'];
  				}

  				var years = [2010, 2011, 2012, 2013, 2014, 2015, 2016];

				var year_buttons = d3.select("body")
					.append("div")
					.attr("class", "year_buttons")
					.selectAll("div")
					.data(years)
					.enter()
					.append("div")
					.text(function(d) {
						return d;
								})
					.style("color", "black")

  				select.on("change", function(d) {
  				
  					//select which industry to look at from the dropdown menu
  					var selectValue = d3.select('select').property('value')

		  			//create legend for wage scale
		  			var colors = ["#f2f0f7", "#dadaeb", "#bcbddc",
		  				"#9e9ac8", "#756bb1", "#54278f"];
	
    				//get min and max wages for entire year range for choropleth scale
    				var wageRangeMin = d3.min(nested, function(d){
    					for (var i = 0; i < d.values.length; i++){
    						if (d.values[i]['key'] === selectValue){
    							return d.values[i].values['minWage'];
    						}
    					}
    				})

    				var wageRangeMax = d3.max(nested, function(d){
    					for (var i = 0; i < d.values.length; i++){
    						if (d.values[i]['key'] === selectValue){
    							return d.values[i].values['maxWage'];
    						}
    					}
    				})

    				var wageRange = [wageRangeMin, wageRangeMax]

				  	var color = d3.scale.quantize()
				  		.domain(wageRange)
    					.range(colors);


    				var title = ["Estimated Average Hourly Wage"];


					var width = 960,
   					height = 500,
    				boxmargin = 4,
    				lineheight = 14,
    				keyheight = 10,
    				keywidth = 40,
    				boxwidth = 2 * keywidth;

    				var margin = { "left": 600, "top": 20 };

    				var legend = svg.append("g")
    					.attr("transform", "translate ("+margin.left+","+margin.top+")")
    					.attr("class", "legend")

    				legend.selectAll("text")
    					.data(title)
    					.enter()
    					.append("text")
    					.attr("class", "legend-title")
    					.attr("y", -5)
    					.attr("x", -20)
    					.text(function(d) { return d; })
    	

    				var lb = legend.append("rect")
    					.attr("class", "legend-box")
    					.attr("width", 210)
    					.attr("height", 20)
    					.attr("x", -35)
    					.attr("y", 0)


    				var li = legend.append("g")
    					.attr("class", "legend-items");	

    				li.selectAll("text")
    					.data(wageRange)
    					.enter()
    					.append("text")
    					.attr("x", function(d, i){
    						if(i === 0){
    							return -30;
    						}else{
    						return 145;
    					}
    					})
    					.attr("y", 15)
   						.text(function(d) { return "$"+d.toFixed(2); });

    				li.selectAll("rect")
    					.data(colors.map(function(col) {
      						var d = color.invertExtent(col);
      							return d;
    							}))
    					.enter()
    					.append("rect")
    					.attr("x", function(d, i) { return i*20; })
    					.attr("y", 5)
   						.attr("width", 40)
    					.attr("height", 10)
    					.style("fill", function(d) { return color(d[0]); });


	  				function update(year) {
	                	var filtered = nested.filter(function(d){
	                		return new Date(d['key']).getUTCFullYear() === year;
	                	});

	                	//replace this with adding year buttins one at a time as they animate
	                	//d3.select("h3")
	                		//.text(year);
	                	for (var i = 0; i<year_buttons[0].length; i++){
	                		if (year_buttons[0][i]['innerText'] === year){
	                			d3.select(year_buttons[0][i])
	                				.style('background', 'black');
	                		}
	                	}

			  			function choropleth(d){
				  			var selected_data = filtered[0].values;

				  			for (var i = 0; i < selected_data.length; i++){
				  				if (selected_data[i]['key'] === selectValue){
				  					var wage_data = selected_data[i].values['wages'];
				  				} 
				  			}

				  			for (var i = 0; i < wage_data.length; i++){
				  				if (wage_data[i][0] === d.properties.NAME){
				  					return color(wage_data[i][1]);
				  				}
				  			}
				  		}
			  				
			  			svg.selectAll('path')
			  				.transition()
			  				.duration(500)
			  				.style('fill', choropleth)
			  				.style('stroke', "black")
			  				

			  			}
						
			  		var year_idx = 0;

					var year_interval = setInterval(function() {
						//animate visualization thru each year
						update(years[year_idx]);

						year_idx++;

						//once animation is finished looping thru years, 
						//create buttons to loop back thru speciic years
						//via clicking on the button
						if(year_idx >= years.length){
							clearInterval(year_interval);

							year_buttons.on("click", function(d) {
								d3.select(".year_buttons")
									.selectAll("div")
									.transition()
									.duration(500)
									.style("color", "black")
									.style("background", "white")
								d3.select(this)
									.transition()
									.duration(500)
									.style("background", "darkBlue")
									.style("color", "white");
								update(d);
							});
						}
					}, 1000);
				})
			}

  			var format = d3.time.format("%Y");


   			d3.csv("./State_OES.csv", function(d) {
    		// transform data
    			d['year'] = format.parse(d['year']);
    			d['h_mean'] = +d['h_mean'];
    			
    			return d;
    		}, plot_points);
   		};
  		</script>
	</head>
<body>
  	<script type="text/javascript">
  		d3.json("./map.json", draw);
  	</script>
</body>
</html>
