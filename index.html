<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>

  <style>
    h1 {
      text-align: center;
    }

    p {
      text-align: center;
      font-size: 80%;
      font-weight: lighter;
    }

    html,
    body,
    svg {
    	height: auto;
    	width: 100%;
    	overflow: visible;
    }

    .map {
    	outline-style: solid;
    	height: auto;
    	width: 100%;
    }


  </style>

  <script type="text/javascript">

  	function draw(geo_data) {

  		var svg = d3.select("body")
  			.append("svg")
  			.append('g')
  			.attr('class', 'map');

  		var projection = d3.geo.mercator()
  			.scale(600)
  			.translate([1600,650]);

  		var path = d3.geo.path().projection(projection);

  		var map = svg.selectAll('path')
  			.data(geo_data.features)
  			.enter()
  			.append('path')
  			.attr('d', path)
  			.style('fill', 'rgb(9,157,217)')
  			.style('stroke', 'black')
  			.style('stroke-width', 0.5);

  		function plot_points(data) {
  			// draw circles logic
  			var nested = d3.nest()
  				.key(function(d) {
  					return d['area'];
  				})
  				.rollup(function(leaves) {
  					var total = d3.sum(leaves, function(d) {
  						return d['tot_emp'];
  				 	});
  					var coords = leaves.map(function(d) {
  						return projection([+d.longitude, +d.latitude]);
  					});
  					var center_x = d3.mean(coords, function(d) {
  						return d[0];
  					});
  					var center_y = d3.mean(coords, function(d) {
  						return d[1];
  					});
  					return {
  						'tot_emp' : total,
  						'x' : center_x,
  						'y' : center_y
  					};
  				})
  				.entries(data);

  			var employment_extent = d3.extent(nested, function(d) {
  				return d.values['tot_emp'];
  			});

  			var radius = d3.scale.sqrt()
  				.domain(employment_extent)
  				.range([0,12]);

  			svg.append('g')
  				.attr("class", "bubble")
  				.selectAll("circle")
  				//sort data so smaller circles don't get hidden under larger ones
  				.data(nested.sort(function(a,b) {
  					return b.values['tot_emp'] - a.values['tot_emp'];
  				}))
  				.enter()
  				.append("circle")
  				.attr('cx', function(d) {
  					return d.values['x'];
  				})
  				.attr('cy', function(d) {
  					return d.values['y'];
  				})
  				.attr('r', function(d) {
  					return radius(d.values['tot_emp']);
  				})
  				.attr('fill', 'rgb(247, 148, 32)')
  				.attr('stroke', 'black')
  				.attr('stroke-width', 0.7)
  				.attr('opacity', 0.7);
  		};

  		var format = d3.time.format("%Y")


   		d3.csv("./State_OES.csv", function(d) {
    	// transform data
    		d['year'] = format.parse(d['year']);
    		d['tot_emp'] = +d['tot_emp'];
    		return d;
    }, plot_points);

  	};

  </script>
</head>
<body>
	<h1> Total Employment by State </h1>
	<p> As reported by the Bureau of Labor Statistics 2010-2016
  	<script type="text/javascript">

  		d3.json("./map.json", draw);
  	</script>
</body>
</html>
