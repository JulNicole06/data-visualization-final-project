<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  	<style>
  		* {
		    -webkit-box-sizing: border-box;
		    -moz-box-sizing: border-box;
		    -ms-box-sizing: border-box;
		    box-sizing: border-box;
		}
  		h1 {
      		text-align: center;
      		font-size:  100%;
      		order: 1;
    	}

    	h2 {
    		font-size: 90%;
    		text-align: center;
    		order: 2;
    	}

    	div.year_buttons {
    		display: -webkit-flex;
  			display: flex;
  			flex-wrap: wrap;
  			width: 50%;
  			order: 4;
  			justify-content: space-between;
  			margin: 2%;
    	}

    	div.year_buttons div {
        	display: -webkit-flex;
  			display: flex;
      	}

    	html, body, svg{
    		display: -webkit-flex;
  			display: flex;
  			justify-content: center;
  			align-items: center;
    	}

    	body {
    		flex-direction: column;
    	}

    	svg{
    		order: 5;
    	}

    	.map {
    		display: -webkit-flex;
 			display: flex;	

    	}

    	circle {
    		stroke: black;
    		stroke-width: 0.7;
    		opacity: 0.7;
    	}

    	.select {
    		display: -webkit-flex;
  			display: flex;
    		margin: auto;
    		order: 3;
    	}



  	</style>
  	<script type="text/javascript">
  		function draw(geo_data) {

  			d3.select("body")
  				.append("h1")
  				.text("Industry Changes from 2010-2016");


  			d3.select("body")
  				.append("h2")
  				.text("Select an industry to see how its employment numbers and highest average salary change year to year");


  			d3.select("body")
  				.append("h3");

  			var width = 960,
  				height = 500;

  			var svg = d3.select("body")
  				.append("svg")
  				.attr("width", width)
  				.attr("height", height)
  				.append('g')
  				.attr('class', 'map');

  			var projection = d3.geo.albersUsa()
  				.scale(1070)
  				.translate([width/2, height/2])

  			var path = d3.geo.path().projection(projection);

  			var map = svg.selectAll('path')
  				.data(geo_data.features)
  				.enter()
  				.append('path')
  				.attr('d', path)
  				.style('fill', 'lightBlue')
  				.style('stroke', 'black')
  				.style('stroke-width', 0.5);


  			var paths = svg.selectAll('path')
		  		.attr("id", function(d){
		  			statesRemoved = ["American Samoa", "Guam", "Commonwealth of the Northern Mariana Islands", "United States Virgin Islands", "Puerto Rico"]
		  			for (var i = 0; i<statesRemoved.length; i++){
		  				if (d.properties.NAME === statesRemoved[i]){
		  					return "remove";
		  				} 
		  			}
		  		})

		  	svg.selectAll('path#remove').remove();
		  	

  			function plot_points(data) {
  				//add all possible invisible circles
				var industries = ["Select an Industry: ", 
					"Legal Occupations", 
					"Management Occupations",
					"Healthcare Practitioners and Technical Occupations", 
					"Architecture and Engineering Occupations", 
					"Business and Financial Operations Occupations", 
					"Computer and Mathematical Occupations",
					"Life, Physical, and Social Science Occupations", 
					"Arts, Design, Entertainment, Sports, and Media Occupations", 
					"Education, Training, and Library Occupations",
					"Protective Service Occupations",
					"Construction and Extraction Occupations",
					"Sales and Related Occupations",
					"Community and Social Service Occupations",
					"Production Occupations",
					"Installation, Maintenance, and Repair Occupations",
					"Transportation and Material Moving Occupations",
					"Farming, Fishing, and Forestry Occupations",
					"Office and Administrative Support Occupations",
					"Healthcare Support Occupations",		
					"Personal Care and Service Occupations",
					"Building and Grounds Cleaning and Maintenance Occupations",
					"Food Preparation and Serving Related Occupations"];

				var select = d3.select('body')
					.append('select')
					.attr('class', 'select')
					.on('change', onchange);

				var options = select.selectAll('option')
					.data(industries).enter()
					.append('option')
					.text(function(d){
						return d;
					});

  				var nested = d3.nest()
  					.key(function(d) {
  						return d['year'].getUTCFullYear();
  					})
  					.key(function(d) {
 						return d['occ_title'];
 					})
  					.rollup(function(leaves){
  						var max_hourly_salary = d3.max(leaves, function(d){
  							return d['h_mean'];
  						});

  						var max_employment = d3.max(leaves, function(d){
  							return d['tot_emp']
  						});

  						for (var i = 0; i<leaves.length; i++){
  							if(leaves[i]['h_mean'] === max_hourly_salary){
  								var wage_state = leaves[i]['state'];
  								var coords = projection([+leaves[i]['longitude'], +leaves[i]['latitude']]);
  								var center_x = coords[0];
  								var center_y = coords[1];
  							} else {
  								continue;
  							}
  						}

  						//get list of all states and corresponding employment numbers
  						employment_array = []
  						for (var i = 0; i<leaves.length; i++){
  							employment_array.push([(leaves[i]['state']), (leaves[i]['tot_emp'])])
  						}

  						return {
  							'state' : wage_state,
  							'max_hourly_salary' : +max_hourly_salary,
  							'center_x' : center_x,
  							'center_y' : center_y,
  							//'emp_state': emp_state
  							'employment': employment_array
  						};
  					})
  					.entries(data);
  				//get the range of hourly mean values across entire dataset
  				var hourly_salary_extent = d3.extent(data, function(d) {
  					return +d['h_mean'];
  				});

  				var radius = d3.scale.sqrt()
  					.domain(hourly_salary_extent)
  					.range([5,15]);

  				function key_func(d) {
  					return d['key'];
  				}

  				var years = [2010, 2011, 2012, 2013, 2014, 2015, 2016];

				var year_buttons = d3.select("body")
					.append("div")
					.attr("class", "year_buttons")
					.selectAll("div")
					.data(years)
					.enter()
					.append("div")
					.text(function(d) {
						return d;
								})
					.style("color", "black")
					.style("background", "lightBlue");


  				select.on("change", function(d) {

  					//select which industry to look at from the dropdown menu
  					var selectValue = d3.select('select').property('value')

  					function circle_values(d, type){
  						//return the x, y coordinates and radius values for circles according
  						//to the selected industry from the dropdown menu
		                	for (var idx = 0; idx< d.values.length; idx++){
		                		if (d.values[idx]['key'] === selectValue){
		                			var center_x = d.values[idx].values['center_x'];
		                			var center_y = d.values[idx].values['center_y'];
		                			var r = radius(d.values[idx].values['max_hourly_salary']);
		                		}
		                	}
		                	switch(type) {
		                		case 'center_x':
		                			return center_x;
		                			break;
		                		case 'center_y':
		                			return center_y;
		                			break;
		                		case 'r':
		                			return r;
		                	}
		                }
		            //create empty placeholders for circles to get appended to
					svg.append('g')
		  				.attr("class", "bubble")
		  				.selectAll("circle")
		  				.data(nested, key_func)
		  				.enter()

	  				function update(year) {
	                	var filtered = nested.filter(function(d){
	                		return new Date(d['key']).getUTCFullYear() === year;
	                	});

	                	d3.select("h3")
	                		.text(year);

		             	var circles = svg.selectAll('circle')
		                               .data(filtered, key_func);

		                //remove circles when transitioning to another year
		                circles.exit().remove();


		                //add new circles for next years data in animation
			            circles.enter()
			             	.append("circle")
			             	.transition()
			             	.duration(500)
			  				.attr('cx', function(d){
			  					var result = circle_values(d, 'center_x');
			  					return result;
			  				})
			  				.attr('cy', function(d){
			  					 var result = circle_values(d, 'center_y');
			  					 return result;
			  				})
			  				.attr('r', function(d){
			  					var result = circle_values(d, 'r');
			  					return result;
			  				})
			  				.attr("fill", "#d95f02");


			  			//function color_high_emp_state(d){
			  				//Selects the state with the highest total employment for a 
			  				//selected industry and fills it with dark blue
			  				//var selected_data = filtered[0].values;

			  				//for(var idx = 0; idx< selected_data.length; idx++){

			  					//if (selected_data[idx]['key']===selectValue){
			  						//var emp_state = selected_data[idx].values['emp_state'];
			  						//if(d.properties.NAME === emp_state){
			  							//return "darkBlue";
			  						//}else{
			  							//return "lightBlue";
			  						//}
			  					//}
			  				//}
			  			//}
			  			function choropleth(d){
				  			var selected_data = filtered[0].values;

				  			for (var i = 0; i < selected_data.length; i++){

				  				if (selected_data[i]['key'] === selectValue){
				  					var employment_data = selected_data[i].values['employment'];

				  					var employment_extent = d3.extent(employment_data, function(d){
				  						return d[1];
				  					});


				  					var color = d3.scale.quantize()
				  						.domain(employment_extent)
    									.range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#3182bd", "#08519c"]);



				  					for (var i = 0; i<employment_data.length; i++){
				  						if (d.properties.NAME === employment_data[i][0]){
				  							return color(employment_data[i][1]);
				  						}
				  					}
				  				}
				  			}

				  		}
			  				
			  			svg.selectAll('path')
			  				.transition()
			  				.duration(500)
			  				.style('fill', choropleth)
			  				.style('stroke', "black")
			  				

			  			}
						
			  		var year_idx = 0;

					var year_interval = setInterval(function() {
						//animate visualization thru each year
						update(years[year_idx]);

						year_idx++;

						//once animation is finished looping thru years, 
						//create buttons to loop back thru speciic years
						//via clicking on the button
						if(year_idx >= years.length){
							clearInterval(year_interval);

							year_buttons.on("click", function(d) {
								d3.select(".year_buttons")
									.selectAll("div")
									.transition()
									.duration(500)
									.style("color", "black")
									.style("background", "lightBlue");
								d3.select(this)
									.transition()
									.duration(500)
									.style("background", "darkBlue")
									.style("color", "white");
								update(d);
							});
						}
					}, 1000);
				})
			}

  			var format = d3.time.format("%Y");


   			d3.csv("./State_OES.csv", function(d) {
    		// transform data
    			d['year'] = format.parse(d['year']);
    			d['tot_emp'] = +d['tot_emp'];
    			d['h_mean'] = +d['h_mean'];
    			
    			return d;
    		}, plot_points);
   		};
  		</script>
	</head>
<body>
  	<script type="text/javascript">
  		d3.json("./map.json", draw);
  	</script>
</body>
</html>
